name: Windowsç³»ç»Ÿèµ„æºç®¡ç†å·¥å…·æ„å»º

on:
  push:
    branches: [ main, master ]
  create:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, windows-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: å‡çº§pip
      run: python -m pip install --upgrade pip
    
    - name: è®¾ç½®ç‰ˆæœ¬å·
      id: version
      run: |
        if ($env:GITHUB_REF -match "refs/tags/v(.*)")
        {
          $version = $matches[1]
        }
        else
        {
          $version = "1.0.$env:GITHUB_RUN_NUMBER"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: è·³è¿‡UPXå®‰è£…ï¼ˆé¿å…ç½‘ç»œé—®é¢˜ï¼‰
      run: |
        echo "è·³è¿‡UPXå®‰è£…ä»¥é¿å…ç½‘ç»œè¶…æ—¶é—®é¢˜"
        echo "UPX_AVAILABLE=false" >> $env:GITHUB_ENV
      continue-on-error: true
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        # Install essential build tools first
        python -m pip install --upgrade pip wheel setuptools
        
        # Install dependencies from requirements.txt if it exists
        if (Test-Path "requirements.txt") {
          pip install -r requirements.txt
        }
        
        # Install PyInstaller and Windows-specific packages
        pip install pyinstaller
        if ($env:RUNNER_OS -eq "Windows") {
          pip install pywin32
        }
      continue-on-error: false
    
    - name: æ„å»ºæœåŠ¡å™¨èµ„æºé…ç½®æå‡å·¥å…·
      run: |
        pyinstaller --onefile --windowed --name "ResourceManager-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist --clean --noconfirm resource_manager.py
      continue-on-error: true
    
    - name: æ„å»ºæœåŠ¡å™¨èµ„æºé…ç½®æå‡å·¥å…·ï¼ˆæ§åˆ¶å°ç‰ˆæœ¬ï¼‰
      run: |
        pyinstaller --onefile --console --name "ResourceManager-Console-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist --clean --noconfirm resource_manager.py
      continue-on-error: true
    
    - name: è·³è¿‡æ–‡ä»¶å‹ç¼©
      run: |
        echo "è·³è¿‡UPXå‹ç¼©æ­¥éª¤ä»¥ç®€åŒ–æ„å»ºè¿‡ç¨‹"
        Get-ChildItem -Path "dist" -Filter "*.exe" | ForEach-Object {
          echo "ä¿æŒåŸå§‹æ–‡ä»¶: $($_.Name)"
        }
      continue-on-error: true
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-tools-${{ matrix.os }}-v${{ steps.version.outputs.VERSION }}
        path: dist/*.exe
        retention-days: 30
    
    - name: åˆ›å»ºå‘å¸ƒï¼ˆä»…æ ‡ç­¾è§¦å‘ï¼‰
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*.exe
        name: Windowsç³»ç»Ÿèµ„æºç®¡ç†å·¥å…· v${{ steps.version.outputs.VERSION }}
        body: |
          ## æœåŠ¡å™¨èµ„æºé…ç½®æå‡å·¥å…· v${{ steps.version.outputs.VERSION }}
          
          ### åŒ…å«å·¥å…·:
          - **ResourceManager**: æœåŠ¡å™¨èµ„æºé…ç½®æå‡å·¥å…·ï¼ˆGUIç‰ˆæœ¬ï¼‰
            - CPUå’Œå†…å­˜åŠ¨æ€ç®¡ç†
            - å®šæ—¶è®¡åˆ’å’Œå¤šæ—¶æ®µè‡ªåŠ¨å¼€å¯
            - ç³»ç»Ÿèµ„æºç›‘æ§å’ŒçŠ¶æ€æ˜¾ç¤º
            - Windowsç‰¹å®šä¼˜åŒ–
          - **ResourceManager-Console**: æœåŠ¡å™¨èµ„æºé…ç½®æå‡å·¥å…·ï¼ˆæ§åˆ¶å°ç‰ˆæœ¬ï¼‰
          
          ### ä¸»è¦åŠŸèƒ½:
          - ğŸš€ CPUå’Œå†…å­˜å³°å€¼è®¾ç½®
          - ğŸ“Š å®æ—¶ç³»ç»Ÿèµ„æºç›‘æ§
          - â° å®šæ—¶è®¡åˆ’ç®¡ç†
          - ğŸ”§ å¯åŠ¨åœæ­¢æŒ‰é’®æ§åˆ¶
          - ğŸ–¥ï¸ Windowsç³»ç»Ÿä¼˜åŒ–
          - ğŸ“ˆ å†²çªé¿å…æœºåˆ¶
          
          ### æ”¯æŒç³»ç»Ÿ:
          - Windows 10/11
          - Windows Server 2019/2022
          
          ### ä½¿ç”¨è¯´æ˜:
          1. ä¸‹è½½å¯¹åº”Windowsç‰ˆæœ¬çš„å·¥å…·
          2. ç›´æ¥è¿è¡Œexeæ–‡ä»¶ï¼Œæ— éœ€å®‰è£…
          3. GUIç‰ˆæœ¬æä¾›ç°ä»£ç®€çº¦çš„å›¾å½¢ç•Œé¢
          4. æ§åˆ¶å°ç‰ˆæœ¬æ”¯æŒå‘½ä»¤è¡Œæ“ä½œ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}