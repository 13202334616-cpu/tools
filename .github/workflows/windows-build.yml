name: Windows系统资源管理工具构建

on:
  push:
    branches: [ main, master ]
  create:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        os: [windows-2019, windows-2022]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: 升级pip
      run: python -m pip install --upgrade pip
    
    - name: 设置版本号
      id: version
      run: |
        if ($env:GITHUB_REF -match "refs/tags/v(.*)")
        {
          $version = $matches[1]
        }
        else
        {
          $version = "1.0.$env:GITHUB_RUN_NUMBER"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: 安装UPX压缩工具
      run: |
        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-win64.zip" -OutFile "upx.zip"
        Expand-Archive -Path "upx.zip" -DestinationPath "."
        $env:PATH += ";$PWD\upx-4.2.1-win64"
        echo "$PWD\upx-4.2.1-win64" >> $env:GITHUB_PATH
    
    - name: 安装Python依赖
      run: |
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: 构建CPU管理器
      run: |
        pyinstaller --onefile --windowed --name "CPUManager-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist cpu_manager_app.py
    
    - name: 构建内存管理器
      run: |
        pyinstaller --onefile --windowed --name "MemoryManager-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist memory_manager_app.py
    
    - name: 构建系统仪表盘
      run: |
        pyinstaller --onefile --windowed --name "SystemDashboard-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist system_dashboard.py
    
    - name: 构建CPU管理器CLI版本
      run: |
        pyinstaller --onefile --console --name "CPUManager-CLI-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist cpu_manager_cli.py
    
    - name: 构建系统信息CLI版本
      run: |
        pyinstaller --onefile --console --name "SystemInfo-CLI-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist system_info_cli.py
    
    - name: 压缩可执行文件
      run: |
        Get-ChildItem -Path "dist" -Filter "*.exe" | ForEach-Object {
          upx --best $_.FullName
        }
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v3
      with:
        name: windows-tools-${{ matrix.os }}-v${{ steps.version.outputs.VERSION }}
        path: dist/*.exe
        retention-days: 30
    
    - name: 创建发布（仅标签触发）
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*.exe
        name: Windows系统资源管理工具 v${{ steps.version.outputs.VERSION }}
        body: |
          ## Windows系统资源管理工具 v${{ steps.version.outputs.VERSION }}
          
          ### 包含工具:
          - **CPUManager**: CPU动态管理工具（GUI版本）
          - **MemoryManager**: 内存管理工具（GUI版本）
          - **SystemDashboard**: 系统监控仪表盘
          - **CPUManager-CLI**: CPU管理工具（命令行版本）
          - **SystemInfo-CLI**: 系统信息查看工具（命令行版本）
          
          ### 支持系统:
          - Windows 10/11
          - Windows Server 2019/2022
          
          ### 使用说明:
          1. 下载对应Windows版本的工具
          2. 直接运行exe文件，无需安装
          3. GUI版本提供图形界面操作
          4. CLI版本支持命令行参数调用
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}