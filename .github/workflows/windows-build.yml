name: Windows系统资源管理工具构建

on:
  push:
    branches: [ main, master ]
  create:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, windows-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'requirements-minimal.txt'
    
    - name: 升级pip
      run: python -m pip install --upgrade pip
    
    - name: 设置版本号
      id: version
      run: |
        if ($env:GITHUB_REF -match "refs/tags/v(.*)")
        {
          $version = $matches[1]
        }
        else
        {
          $version = "1.0.$env:GITHUB_RUN_NUMBER"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: 跳过UPX安装（避免网络问题）
      run: |
        echo "跳过UPX安装以避免网络超时问题"
        echo "UPX_AVAILABLE=false" >> $env:GITHUB_ENV
      continue-on-error: true
    
    - name: 安装Python依赖
      run: |
        # Use very conservative settings to avoid network issues
        python -m pip install --timeout 600 --retries 5 --upgrade pip
        
        # Install only essential packages one by one
        pip install --timeout 600 --retries 5 --no-deps psutil
        pip install --timeout 600 --retries 5 --no-deps pyinstaller
        
        # Install pywin32 only on Windows
        if ($env:RUNNER_OS -eq "Windows") {
          pip install --timeout 600 --retries 5 --no-deps pywin32
        }
      continue-on-error: false
    
    - name: 构建CPU管理器
      run: |
        pyinstaller --onefile --windowed --name "CPUManager-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist cpu_manager_app.py
      continue-on-error: true
    
    - name: 构建内存管理器
      run: |
        pyinstaller --onefile --windowed --name "MemoryManager-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist memory_manager_app.py
      continue-on-error: true
    
    - name: 构建系统仪表盘
      run: |
        pyinstaller --onefile --windowed --name "SystemDashboard-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist system_dashboard.py
      continue-on-error: true
    
    - name: 构建CPU管理器CLI版本
      run: |
        pyinstaller --onefile --console --name "CPUManager-CLI-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist cpu_manager_cli.py
      continue-on-error: true
    
    - name: 构建系统信息CLI版本
      run: |
        pyinstaller --onefile --console --name "SystemInfo-CLI-v${{ steps.version.outputs.VERSION }}-${{ matrix.os }}" --distpath dist system_info_cli.py
      continue-on-error: true
    
    - name: 跳过文件压缩
      run: |
        echo "跳过UPX压缩步骤以简化构建过程"
        Get-ChildItem -Path "dist" -Filter "*.exe" | ForEach-Object {
          echo "保持原始文件: $($_.Name)"
        }
      continue-on-error: true
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: windows-tools-${{ matrix.os }}-v${{ steps.version.outputs.VERSION }}
        path: dist/*.exe
        retention-days: 30
    
    - name: 创建发布（仅标签触发）
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*.exe
        name: Windows系统资源管理工具 v${{ steps.version.outputs.VERSION }}
        body: |
          ## Windows系统资源管理工具 v${{ steps.version.outputs.VERSION }}
          
          ### 包含工具:
          - **CPUManager**: CPU动态管理工具（GUI版本）
          - **MemoryManager**: 内存管理工具（GUI版本）
          - **SystemDashboard**: 系统监控仪表盘
          - **CPUManager-CLI**: CPU管理工具（命令行版本）
          - **SystemInfo-CLI**: 系统信息查看工具（命令行版本）
          
          ### 支持系统:
          - Windows 10/11
          - Windows Server 2019/2022
          
          ### 使用说明:
          1. 下载对应Windows版本的工具
          2. 直接运行exe文件，无需安装
          3. GUI版本提供图形界面操作
          4. CLI版本支持命令行参数调用
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}